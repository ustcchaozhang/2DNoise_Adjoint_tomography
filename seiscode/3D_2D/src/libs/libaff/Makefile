# this is <Makefile>
# ----------------------------------------------------------------------------
# 
# Copyright (c) 2002 by Thomas Forbriger (IMG Frankfurt) 
# 
# libaff is the "Array Friederich Forbriger", a container for numbers
#
# It is published under terms of the GNU General Public License.
#
# ----
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version. 
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
# ----
#     
# Please have a look at the README file coming along with the source code in
# this directory for further notes regarding provided functionality,
# prerequisites and installation.
#
# REVISIONS and CHANGES 
#    06/12/2002   V1.0   Thomas Forbriger
#    27/12/2002   V1.1   doxygen reads Fortran code and files generated by f2c
#    03/01/2003   V1.2   improved white-space-eating awk-script
#    04/01/2003   V1.3   corrected yesterday's change 
#    28/03/2006   V1.4   provide a package
#    11/12/2007   V1.5   library and test programs compile well on a 64bit
#                        systems; the Fortran interface was tested with g77
#                        and f2c (not yet with gfortran)
#    17/08/2010   V1.6   prepare for new environment settings
#    18/09/2010   V1.7   TF_WWWBASEDIR and TF_REMCMMNT must be used
#    10/11/2010   V1.8   removed fragments for binarry
#    17/01/2011   V1.9   distinguish library creation and installation
#    27/07/2011   V1.10  give precedence to $LOCINCLUDEDIR over 
#                        $SERVERINCLUDEDIR 
#    26/01/2014          eliminate comment stripping 
#    21/10/2016          add array usage example
# 
# ============================================================================

.PHONY: all
all: install doc

.PHONY: doc
doc: doxydoc

LIBRARIES=libaff.a libaff.so

.PHONY: install
install: $(addprefix $(LOCLIBDIR)/,$(LIBRARIES))
$(LOCLIBDIR)/%: install-include %
	mkdir -pv $(LOCLIBDIR)
	/bin/mv -fv $(word 2,$^) $(LOCLIBDIR)
	 
# ============================================================================
# a variable definition to check variable settings
# ------------------------------------------------

CHECKVAR=$(if $($(1)),,$(error ERROR: missing variable $(1)))
CHECKVARS=$(foreach var,$(1),$(call CHECKVAR,$(var)))

# check for required variables
$(call CHECKVARS,LOCINCLUDEDIR LOCLIBDIR TF_WWWBASEDIR)

#======================================================================
# files and paths
# ---------------

# all header files used within this project
HEADERS=$(shell find . -name \*.h)
# all source code to be compiled to object files and to be included
# in the binary version of the library
# (see below for the configuration of a preinstantiated version of template
# code)
SRC=lib/error.cc dump.cc lib/strided.cc lib/stridedstepper.cc \
    lib/seriesstepper.cc fortranshape.cc 
# test programs are placed in a subdirectory
TESTS=$(wildcard tests/*.cc)
# usage examples are placed in a subdirectory
EXAMPLES=$(wildcard examples/*.cc)
# whereever we find a README, we will use it
README=$(shell find . -name README) 
# the frame of doxygen documentation is palced in text files
DOXYTXT=$(shell find . -name doxygen\*.txt) 

# place where we will copy header files
INCINSTALLPATH=$(LOCINCLUDEDIR)/aff
# place where we will copy the binary library
LIBINSTALLPATH=$(LOCLIBDIR)

# name of installed (exported) header files (these are the names in your
# include directory)
INSTHEADER=$(addprefix $(INCINSTALLPATH)/,$(filter-out ./tests/%,$(HEADERS)))

#======================================================================
# compiler and preprocessor flags
# -------------------------------
FLAGS=
FLAGS+=$(MYFLAGS) -fPIC
CXXFLAGS+=-Wall $(FLAGS) -O3
LDFLAGS=$(addprefix -L,$(LOCLIBDIR) $(subst :, ,$(SERVERLIBDIR)))
CPPFLAGS=$(addprefix -I,$(LOCINCLUDEDIR) $(subst :, ,$(SERVERINCLUDEDIR))) \
     $(FLAGS)

#======================================================================
# targets
# -------

# files which are to be edited
flist: Makefile tests/Makefile examples/Makefile \
       doxydoc.cfg $(README) COPYING \
       $(HEADERS) $(SRC) $(EXAMPLES) $(TESTS) \
	 $(wildcard doxy*.cfg) $(DOXYTXT) \
       tests/f77common.inc tests/f77procs.f $(TF_EDIT)
	echo $(filter-out lib/% tests/%,$^) | tr ' ' '\n' | sort > $@
	echo $(filter lib/%,$^) | tr ' ' '\n' | sort >> $@
	echo $(filter tests/%,$^) | tr ' ' '\n' | sort >> $@

# Offers you a list of files to edit (ask Thomas for appropriate vim
# configuration).
.PHONY: edit
edit: flist; vim $<

# Target clean removes everything except the source code, headers and
# documentation. (See also doxyclean)
.PHONY: clean
clean: ; 
	-find . -name \*.bak | xargs --no-run-if-empty /bin/rm -v
	-find . -name \*.o | xargs --no-run-if-empty /bin/rm -v
	-find . -name \*.d | xargs --no-run-if-empty /bin/rm -v
	-/bin/rm -vf flist *.o install-include *.xxx junk* *.a *.so
	cd tests; $(MAKE) clean

#======================================================================
# library part
# ============
#
# create the binary library
# -------------------------
LIBOBS=$(ALLOBS) $(patsubst %.cc,%.o,$(SRC))
LIBOBS=$(patsubst %.cc,%.o,$(SRC))

libaff.a: $(INSTHEADER) $(LIBOBS)
	ar rcv $@ $(LIBOBS)
	ranlib $@

libaff.so: $(INSTHEADER) $(LIBOBS)
	$(CXX) $(CXXFLAGS) -shared -o $@ $(LIBOBS)

#======================================================================
# dependencies
# ------------
#
# The compiler is used to create dependency files, which are included below.

%.d: %.cc
	$(SHELL) -ec '$(CXX) -M $(CPPFLAGS) $(TMPPARDEF) $< \
      | sed '\''s,\($(notdir $*)\)\.o[ :]*,$(dir $@)\1.o $@ : ,g'\'' \
        > $@; \
      [ -s $@ ] || rm -f $@'

include $(patsubst %.cc,%.d,$(SRC)) 

# this include will be used once we initiate the precompiled library version
# until then it's just waiting here
#-include $(patsubst %.o,%.d,$(ALLOBS))

#======================================================================
# header files
# ------------
      
$(call CHECKVAR,INCINSTALLPATH)
$(INCINSTALLPATH)/%.h: %.h
	@mkdir -vp $(dir $@)
	-@rm -fv $@
	@/bin/cp -vpd $< $@

# install header files
.PHONY: install-include
install-include: $(INSTHEADER)

#======================================================================
# reinstall target
# is necessary in case of header file problems (e.g. remcmmnt not installed)
.PHONY: clean-include
clean-include: 
	/bin/rm -fv $(INSTHEADER)

.PHONY: reinstall
reinstall:
	$(MAKE) clean
	$(MAKE) clean-include
	$(MAKE) install

#======================================================================
# documentation part
# ------------------
#
# targets commonly used:
# ----------------------
#
# make doxyclean        removes all documentation
# make doxydoc          creates doxygen documentation in the DOXYWWWPATH
# make doxyview         creates doxygen documentation and launches netscape to
#                       browse in the documentation
# make doxyconf         edit the doxygen configuration file
#
# If you launch "make doxydoc" the documentation will be written to
# DOXYWWWPATH (see below). This is meant to export the documentation through
# your homepage. The doxyfull directory is just a symbolic link to this
# directory.
#

$(call CHECKVARS,TF_WWWBASEDIR TF_BROWSER)

DOXYWWWPATH=$(TF_WWWBASEDIR)/libaff

.PHONY: doxyclean doxyview doxydoc doxyconf

doxyclean: ;/bin/rm -rfv $(TF_WWWBASEDIR)/libaff doxydoc.xxx

DOXYSRC=$(DOXYTXT) $(HEADERS) $(SRC) \
  tests/f77procs.P tests/f77procs.f \
  tests/f77common.inc tests/f77common_com.P \
  $(TESTS) $(EXAMPLES)

# create doxygen intermediate configuration
PWD=$(shell env pwd)
doxydoc.xxx: doxydoc.cfg
	sed 's,<OUTPUTDIRECTORY>,$(DOXYWWWPATH),g;s,<STRIPFROMPATH>,$(PWD),g' \
	  $< > $@
# create commented version of doxygen configuration
doxycomm.xxx: doxydoc.cfg
	/bin/cp -vf $< $@; doxygen -u $@

$(DOXYWWWPATH)/html/index.html: doxydoc.xxx $(DOXYSRC)
	mkdir -vp $(DOXYWWWPATH)
	doxygen $<

doxydoc: $(DOXYWWWPATH)/html/index.html

doxyview: $(DOXYWWWPATH)/html/index.html
	$(TF_BROWSER) file:$< &

#----------------------------------------------------------------------
# kdoc (http://sirtaj.net/projects/kdoc/)
# added by Daniel
KDOCDIR=$(HOME)/tmp/affkdoc
kdoc: 
	mkdir -p $(KDOCDIR)
	kdoc -f html -d $(KDOCDIR) -n libaff -p -P -I$(LOCINCLUDEDIR) $(HEADERS)
kdocview: kdoc; $(TF_BROWSER) file:$(KDOCDIR)/index.html &
	
showsections: $(README)
	egrep -n '\\subsection|\\section|\\page' $^

#======================================================================
# delegate test targets
# ---------------------

tests/%.P: 
	cd tests; echo "#############################"; $(MAKE) $(notdir $@)

tests/f2ctest: tests/f77test.cc install-include libaff.a
	cd tests; echo "#############################"; $(MAKE) $(notdir $@)

tests/%: tests/%.cc install-include libaff.a
	cd tests; echo "#############################"; $(MAKE) $(notdir $@)

tests/bin%: tests/bin%.cc install-include libaff.a
	cd tests; echo "#############################"; $(MAKE) $(notdir $@)

tests/%.run: tests/%
	echo "#############################"
	$< $(ARG)
	/bin/rm -fv $< $<.o

# after each modification to the library this target should be used
compile-tests: \
  tests/shapetest.run \
  tests/reprtest.run \
  tests/arraytest.run \
  tests/operatortest.run \
  tests/helpertest.run \
  tests/f77test.run 

#======================================================================
# create package
# --------------
# is delegated to Makefile.packages
# which still has to be coded
ifdef TF_MAKEPKG
package:
	$(MAKE) -f $(TF_MAKEPKG) \
        PACKAGE=libaff \
	  PACKAGETARGETS="src:all:" \
	  PACKAGELIBS="-" \
	  PACKAGEEXPORT="trunk/src/libs/libaff:src"
endif

# ----- END OF Makefile ----- 
